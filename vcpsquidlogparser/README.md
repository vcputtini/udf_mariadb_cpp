## vcpsquidlogparser

It's a library of utility functions to manipulate the log line generated by the Squid-cache proxy.<br>

## Instructions

### Create UDF's

To create (register) the UDF's to used in the database, we will use the DDL's that are encoded in the __docs/create-functions.sql__ file.

__Line command:__ Using mysql command.

mysql [-p] [-D test] <  docs/create-funcs.sql

## Notes
* All tests below were done in a database without any kind of optimization and the table has only one field as shown:
* If you aren't familiar with programming UDFs, access the link for further explanations: https://mariadb.com/kb/en/creating-user-defined-functions/

![](docs/logsquid-tbl.png)

### Documentation

See docs/ folder. Contains several examples of use.

## Reference
- Syntax<br>
Type: Aggregation<br>
_INTEGER slp_sum(string,string,string);_<br>
Arguments:<br>
1st: One these: "squid" | "common" | "combined" (The other formats don't have these fields)<br>
2nd: Log line<br>
3rd: response_time | total_size_req<br>
Comments: This function returns the sumatory of the values referring to the response_time and total_size_req.<br>
![](docs/ex-slparsersum.png)

- Syntax<br>
Type: Aggregation<br>
_INTEGER slp_countbyrm(string, string, string);_<br>
Arguments:<br>
1st: One these: "squid" | "common" | "combined" (The other formats don't have these fields)<br>
2nd: Log line<br>
3rd: GET|PUT|POST|CONNECT|HEAD|DELETE|OPTIONS|PATCH|TRACE|OTHERS
Comments: This function returns the count of URLs that have one of the "HTTP Request Methods" described.
![](docs/ex-countbyrm.png)

- Syntax<br>
Type: Aggregation<br>
_INTEGER slp_countbyhttpcode(string, string, string);_<br>
Arguments:<br>
1st: One these: "squid" | "common" | "combined" (The other formats don't have these fields)<br>
2nd: Log line<br>
3rd: (integer) Http Status Code (e.g: 200, 201, 403 ...)<br>
Comments: This function returns the count of URLs that have one of the "HTTP Status" described.
![](docs/ex-slpcountbyhc.png)

- Syntax<br>
Type: function
_STRING slp_str(string,string,string,[string]);_ or _INTEGER slp_int(string,string,string)_;<br>

slp_str() returns the string fields of the log line and<br>
slp_int() returns the numeric fields of the log lines.

Arguments:<br>
1st: One these: "squid" | "common" | "combined" | "referrer" | "useragent"<br>
2nd: Log line<br>
3rd: Reserved Words: see list docs/reserved-words.txt<br>
4th: Optional argument that is only used if the 3rd argument was "url".
     Possible reserved words are: "protocol", "domain", "path", "query" or "fragment"<br>     
Comments:
    - _slp_str()_: In case the URL is encoded it'll be decoded before being retrieved.
    - Both return the chosen part of the log line.
    - Will return NULL if there is an error or the part doesn't contain a valid value.


* Supported Squid Log Formats<br>
Up to this point the *slp_int() and slp_str()* can handle the default formats of Squid's log types, as follows:<br><br>
 - Log Format: *squid*<br>
  %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt<br>
  UDF Reserved Word: squid<br>

 - Log Format: *common*<br>
   %>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st %Ss:%Sh<br>
   UDF Reserved Word: common<br>

  - Log Format: *combined*<br>
    %>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh<br>
    UDF Reserved Word: combined<br>

  - Log Format: *referrer*<br>
    %ts.%03tu %>a %{Referer}>h %ru<br>
    UDF Reserved Word: referrer<br>

  - Log Format: *useragent*<br>
    %>a [%tl] "%{User-Agent}>h"<br>
    UDF Reserved Word: useragent<br>

* Helpers
    - Syntax<br>
    Type: function<br>
    Brief: Decode a URL<br>
    _STRING slp_urldecode(string);_<br>
    Return: A decoded URL. If an error occurs, or the URL is invalid, it will return NULL.<br>
    Usage Examples<br>
    ```
    SELECT slp_urldecode(slp_str("combined", log, "referrer")) FROM squid_combined_tbl;
    ```

    Using constant string:<br>
    ![](docs/ex-urldecode.png)

    - Syntax<br>
    Type: function<br>
    Brief: Returns a part of the URL.<br>
    _STRING slp_urlparts(string, string)_<br>
    It breaks the URL into its main parts as follows: SCHEME, DOMAIN, PATH, QUERY and FRAGMENT.<br>
    It was inspired by the built-in PARSE_URL() function of Apache(tm) IMPALA(tm).<br>
    Anatomy: <scheme>://DOMAIN:PORT/path?query#fragment<br>
    Reserved words: "scheme" | "domain" | "username" | "password" | "path" | "quey" | "fragment"<br>
    Arguments:<br>
    1st: URL (e.g.: "https://www.fedoraproject.org".)<br>
    2nd: URL part reserved word.

    __Note:__ This function should not be used with raw log lines, the result will be unpredictable.<br>
    First, extract only the URL of the line, using the function slp_str(LOG_FORMAT, RAWLOG_LINE, "url");
    ```
    SELECT  slp_urlparts( slp_str("combined", rawlog, "url"), "scheme" ) from squid_combined_tbl;
    SELECT  slp_urlparts( slp_str("combined", rawlog, "url"), "domain" ) from squid_combined_tbl;
    SELECT  slp_urlparts( slp_str("combined", rawlog, "url"), "username" ) from squid_combined_tbl;
    SELECT  slp_urlparts( slp_str("combined", rawlog, "url"), "password" ) from squid_combined_tbl;
    SELECT  slp_urlparts( slp_str("combined", rawlog, "url"), "path" ) from squid_combined_tbl;
    SELECT  slp_urlparts( slp_str("combined", rawlog, "url"), "query" ) from squid_combined_tbl;
    SELECT  slp_urlparts( slp_str("combined", rawlog, "url"), "fragment" ) from squid_combined_tbl;
    ```

    ```
    SELECT slp_urlparts(url_field, "domain") FROM log_squid;

    SELECT slp_urlparts(url_field, "domain")
    FROM log_squid
    WHERE slp_urlparts(url_field, "scheme") = "https";

    SELECT slp_urlparts("https://www.google.com/search?client=firefox-b-d&q=google+translate","domain");
    Result: www.google.com

    SELECT slp_urlparts("https://www.google.com/search?client=firefox-b-d&q=google+translate","query");
    Result: ?client=firefox-b-d&q=google+translate

    MariaDB [test]> SELECT slp_urlparts("http://USERNAME:PASS111@www.domain.aaa/","password");

    MariaDB [test]> SELECT slp_urlparts("http://USERNAME:PASS111@www.domain.aaa/","password");
    ```
    See docs/ex-slp_urlparts.sql for a more complete example.

    - Syntax<br>
    Type: function<br>
    Brief:  Convenience function that convert the Squid-readable format date to a Unix timestamp.<br>
    _STRING slp_toUnixTs(string)_<br>
    Note: Mandatory date format: dd/Mmm/yyyy:hh:mm:ss or  dd/Mmm/yyyy:hh:mm:ss [-]0000<br>

    ```
    SELECT slp_toUnixTs("09/Jan/2022:12:30:50");
    or
    SELECT SELECT slp_toUnixTs(squid_date) FROM log_combined_tbl;
    ```

    - Syntax<br>
    Type: function<br>
    Brief: Convenience function that convert the numeric Unix timestamp to a Squid-readable format date.<br>
    _STRING slp_toSquidTs(integer)_<br>

    ```
    SELECT slp_toSquidTs(1651410533);
    or
    SELECT slp_toSquidTs(timestamp) FROM  log_squid_tbl;
    ```


* Reserved words to retrieve parts of the log entries<br>
The complete list of words reserved for use in the function can be found in the *docs/reserved-words.txt* file.

* Usage Examples<br>

String fields:
```
SELECT slp_str("squid", RAW_LOG_FIELD, "url") FROM squid_log_tbl;
SELECT slp_str("squid", RAW_LOG_FIELD, "url","domain") FROM squid_log_tbl;
SELECT slp_str("squid", RAW_LOG_FIELD, "url","username") FROM squid_log_tbl;
SELECT slp_str("squid", RAW_LOG_FIELD, "url","password") FROM squid_log_tbl;
SELECT slp_str("squid", RAW_LOG_FIELD, "url","path") FROM squid_log_tbl;
SELECT slp_str("squid", RAW_LOG_FIELD, "url","query") FROM squid_log_tbl;
SELECT slp_str("squid", RAW_LOG_FIELD, "url","fragment") FROM squid_log_tbl;
SELECT slp_str("squid", RAW_LOG_FIELD, "username") FROM squid_log_tbl;

SELECT slp_str("squid", RAW_LOG_FIELD, "url","domain") AS DOMAINS FROM squid_log_tbl HAVING DOMAINS IS NOT NULL;
```
![](docs/ex-slp_str-01.png)

Example using time_convert() function from vcputilities library.
![](docs/ex-time_convert_01.png)

Numerical fields:
```
SELECT slp_int("squid", RAW_LOG_FIELD, "total_size_reply") FROM squid_log_tbl;

SELECT slp_int("squid", RAW_LOG_FIELD, "total_size_reply") AS TOTAL_SIZE FROM squid_log_tbl HAVING TOTAL_SIZE > 1000;

SELECT slp_int("squid", RAW_LOG_FIELD, "timestamp") FROM squid_log_tbl;

SELECT slp_sum("squid", log, "total_size_reply") AS SUM_TOTALS FROM logsquid;

SELECT slp_sum("squid", log, "total_size_reply") AS SUM_TOTALS FROM logsquid HAVING SUM_TOTALS > 1000;

```
